{% extends "base.html" %}

{% block title %}DDNS Dashboard{% endblock %}

{% block content %}

{# -------------------------------------------------------------------------
   Stat cards row
------------------------------------------------------------------------- #}
<div class="card-grid mt-2">
  <div class="stat-card">
    <div class="stat-label">Managed Records</div>
    <div class="stat-value">{{ records | length }}</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Total Updates</div>
    <div class="stat-value">{{ records | sum(attribute='updates') }}</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Total Failures</div>
    <div class="stat-value" style="color: {% if records | sum(attribute='failures') > 0 %}#dc2626{% else %}#1e293b{% endif %};">
      {{ records | sum(attribute='failures') }}
    </div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Check Interval</div>
    <div class="stat-value" style="font-size:1.5rem;">{{ interval }}s</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Next Check In</div>
    <div class="stat-value" id="next-check-countdown" style="font-size:1.5rem; color:#0284c7;">&mdash;</div>
  </div>
</div>

{# -------------------------------------------------------------------------
   Managed records table — full width
------------------------------------------------------------------------- #}
<div class="card mb-2">
  <div class="card-header">
    <span class="card-title">Managed DNS Records</span>
    <span class="htmx-indicator text-xs text-muted">updating…</span>
  </div>

  <div id="records-container">
    {% include "partials/records_table.html" %}
  </div>
</div>

{# -------------------------------------------------------------------------
   All zone A-records — add to managed
------------------------------------------------------------------------- #}
<div class="card mb-2">
  <div class="card-header">
    <span class="card-title">All A-Records in Zone</span>
  </div>
  <div class="card-body">
    {% if all_records %}
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>IP</th>
          <th>TTL</th>
          <th>Proxied</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% set managed_names = records | map(attribute='name') | list %}
        {% for r in all_records %}
        <tr>
          <td class="font-mono text-sm">{{ r.name }}</td>
          <td class="font-mono text-sm">{{ r.content }}</td>
          <td class="text-muted text-sm">{{ r.ttl }}</td>
          <td>
            {% if r.proxied %}
              <span class="badge badge-warning">Proxied</span>
            {% else %}
              <span class="badge badge-neutral">DNS only</span>
            {% endif %}
          </td>
          <td>
            <div class="flex gap-2">
              {% if r.name not in managed_names %}
              <form hx-post="/add-to-managed"
                    hx-target="#records-container"
                    hx-swap="innerHTML"
                    style="display:inline">
                <input type="hidden" name="record_name" value="{{ r.name }}">
                <button type="submit" class="btn btn-primary btn-sm">+ Manage</button>
              </form>
              {% endif %}
              <form hx-post="/delete-record"
                    hx-target="#records-container"
                    hx-swap="innerHTML"
                    hx-confirm="Delete {{ r.name }} from Cloudflare? This cannot be undone."
                    style="display:inline">
                <input type="hidden" name="record_id" value="{{ r.id }}">
                <input type="hidden" name="record_name" value="{{ r.name }}">
                <button type="submit" class="btn btn-danger btn-sm">Delete</button>
              </form>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p class="text-muted text-sm">No A-records found. Configure your API token and zones first.</p>
    {% endif %}
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
(function () {
  const interval = {{ interval | int }};
  let remaining = interval;
  const el = document.getElementById('next-check-countdown');
  function tick() {
    el.textContent = remaining + 's';
    remaining = remaining > 0 ? remaining - 1 : interval;
  }
  tick();
  setInterval(tick, 1000);
}());
</script>
{% endblock %}
