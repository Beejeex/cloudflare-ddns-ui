{% extends "base.html" %}

{% block title %}DDNS Dashboard{% endblock %}

{% block content %}

{# -------------------------------------------------------------------------
   Stat cards row
------------------------------------------------------------------------- #}
<div class="card-grid mt-2">
  <div class="stat-card">
    <div class="stat-label">Managed Records</div>
    <div class="stat-value">{{ records | length }}</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Total Updates</div>
    <div class="stat-value">{{ records | sum(attribute='updates') }}</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Total Failures</div>
    <div class="stat-value" style="color: {% if records | sum(attribute='failures') > 0 %}#dc2626{% else %}#1e293b{% endif %};">
      {{ records | sum(attribute='failures') }}
    </div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Check Interval</div>
    <div class="stat-value" style="font-size:1.5rem;">{{ interval }}s</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Next Check In</div>
    <div class="stat-value" id="next-check-countdown" style="font-size:1.5rem; color:#0284c7;">&mdash;</div>
  </div>
</div>

{# API / auth error banner #}
{% if api_error %}
<div class="alert" style="background:#fef3c7; color:#92400e; border:1px solid #fde68a; display:flex; align-items:center; gap:0.75rem; margin-bottom:1rem;">
  <span style="font-size:1.125rem;">&#9888;</span>
  <div>
    <strong>Cloudflare API error</strong> &mdash; {{ api_error }}
    <span style="margin-left:0.5rem;">
      <a href="/settings" style="color:#0284c7; font-weight:600;">Go to Settings &rarr;</a>
    </span>
  </div>
</div>
{% endif %}

{# -------------------------------------------------------------------------
   Managed records table — full width
------------------------------------------------------------------------- #}
<div class="card mb-2">
  <div class="card-header">
    <span class="card-title">Managed DNS Records</span>
    <span class="htmx-indicator text-xs text-muted">updating…</span>
  </div>

  <div id="records-container">
    {% include "partials/records_table.html" %}
  </div>
</div>

{# -------------------------------------------------------------------------
   Create new A-record
------------------------------------------------------------------------- #}
<div class="card mb-2">
  <div class="card-header">
    <span class="card-title">Create New A-Record</span>
  </div>
  <div class="card-body">
    <div id="create-record-status"></div>
    <form hx-post="/create-record"
          hx-target="#create-record-status"
          hx-swap="innerHTML"
          hx-on:htmx:after-request="if(event.detail.successful && !this.querySelector('.alert-error')) { this.reset(); location.reload(); }"
          style="display:flex; gap:0.75rem; align-items:flex-end; flex-wrap:wrap;">
      <div class="form-group" style="flex:2; min-width:180px; margin-bottom:0;">
        <label for="create-record-name">Record Name (FQDN)</label>
        <input type="text" id="create-record-name" name="record_name"
               placeholder="home.example.com" required>
      </div>
      <div class="form-group" style="flex:1; min-width:140px; margin-bottom:0;">
        <label for="create-record-ip">IP Address</label>
        <input type="text" id="create-record-ip" name="record_ip"
               placeholder="{{ current_ip }}" value="{{ current_ip }}" required>
      </div>
      <div style="padding-bottom:0;">
        <button type="submit" class="btn btn-primary">Create &amp; Manage</button>
      </div>
    </form>
  </div>
</div>

{# -------------------------------------------------------------------------
   All zone A-records — add to managed
------------------------------------------------------------------------- #}
<div class="card mb-2">
  <div class="card-header">
    <span class="card-title">All A-Records in Zone</span>
  </div>
  <div class="card-body">
    {% if all_records %}
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>IP</th>
          <th>TTL</th>
          <th>Proxied</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% set managed_names = records | map(attribute='name') | list %}
        {% for r in all_records %}
        <tr>
          <td class="font-mono text-sm">{{ r.name }}</td>
          <td class="font-mono text-sm">{{ r.content }}</td>
          <td class="text-muted text-sm">{{ r.ttl }}</td>
          <td>
            {% if r.proxied %}
              <span class="badge badge-warning">Proxied</span>
            {% else %}
              <span class="badge badge-neutral">DNS only</span>
            {% endif %}
          </td>
          <td>
            <div class="flex gap-2">
              {% if r.name not in managed_names %}
              <form hx-post="/add-to-managed"
                    hx-target="#records-container"
                    hx-swap="innerHTML"
                    hx-on:htmx:after-request="if(event.detail.successful) location.reload()"
                    style="display:inline">
                <input type="hidden" name="record_name" value="{{ r.name }}">
                <button type="submit" class="btn btn-primary btn-sm">+ Manage</button>
              </form>
              {% else %}
              <span class="badge badge-ok">Managed</span>
              {% endif %}
              <form hx-post="/delete-record"
                    hx-target="#records-container"
                    hx-swap="innerHTML"
                    hx-confirm="Delete {{ r.name }} from Cloudflare? This cannot be undone."
                    hx-on:htmx:after-request="if(event.detail.successful) location.reload()"
                    style="display:inline">
                <input type="hidden" name="record_id" value="{{ r.id }}">
                <input type="hidden" name="record_name" value="{{ r.name }}">
                <button type="submit" class="btn btn-danger btn-sm">Delete</button>
              </form>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p class="text-muted text-sm">
      {% if api_error %}
        Could not load records — check the API error above.
      {% else %}
        No A-records found. Configure your API token and zones in Settings first.
      {% endif %}
    </p>
    {% endif %}
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
(function () {
  const interval = {{ interval | int }};
  let remaining = interval;
  const el = document.getElementById('next-check-countdown');
  function tick() {
    el.textContent = remaining + 's';
    remaining = remaining > 0 ? remaining - 1 : interval;
  }
  tick();
  setInterval(tick, 1000);
}());
</script>
{% endblock %}
