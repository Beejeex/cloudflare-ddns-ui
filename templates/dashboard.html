{% extends "base.html" %}

{% block title %}DDNS Dashboard{% endblock %}

{% block content %}

{# -------------------------------------------------------------------------
   Stat cards row
------------------------------------------------------------------------- #}
<div class="card-grid mt-2">
  <div class="stat-card">
    <div class="stat-label">Managed Records</div>
    <div class="stat-value">{{ records | length }}</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Total Updates</div>
    <div class="stat-value">{{ records | sum(attribute='updates') }}</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Total Failures</div>
    <div class="stat-value" style="color: {% if records | sum(attribute='failures') > 0 %}#dc2626{% else %}#1e293b{% endif %};">
      {{ records | sum(attribute='failures') }}
    </div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Check Interval</div>
    <div class="stat-value" style="font-size:1.5rem;">{{ interval }}s</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Next Check In</div>
    <div class="stat-value" id="next-check-countdown" style="font-size:1.5rem; color:#0284c7;">&mdash;</div>
  </div>
</div>

{# ---- Cloudflare API error banner ---- #}
{% if api_error %}
<div class="alert" style="background:#fef3c7; color:#92400e; border:1px solid #fde68a; display:flex; align-items:center; gap:0.75rem; margin-bottom:1rem;">
  <span style="font-size:1.125rem;">&#9888;</span>
  <div>
    <strong>Cloudflare API error</strong> &mdash; {{ api_error }}
    <span style="margin-left:0.5rem;">
      <a href="/settings" style="color:#0284c7; font-weight:600;">Go to Settings &rarr;</a>
    </span>
  </div>
</div>
{% endif %}

{# ---- UniFi API error banner ---- #}
{% if unifi_error %}
<div class="alert" style="background:#fef3c7; color:#92400e; border:1px solid #fde68a; display:flex; align-items:center; gap:0.75rem; margin-bottom:1rem;">
  <span style="font-size:1.125rem;">&#9888;</span>
  <div>
    <strong>UniFi API error</strong> &mdash; {{ unifi_error }}
    <span style="margin-left:0.5rem;">
      <a href="/settings" style="color:#0284c7; font-weight:600;">Go to Settings &rarr;</a>
    </span>
  </div>
</div>
{% endif %}

{# -------------------------------------------------------------------------
   Managed records — Cloudflare + UniFi unified table
------------------------------------------------------------------------- #}
<div class="card mb-2">
  <div class="card-header">
    <span class="card-title">Managed DNS Records</span>
    <div style="display:flex; align-items:center; gap:0.75rem;">
      {% if unifi_enabled %}
      <span style="display:inline-flex; align-items:center; gap:0.35rem; font-size:0.75rem; color:#64748b;">
        <span style="width:8px; height:8px; border-radius:50%; background:#0284c7; display:inline-block;"></span>
        UniFi active
      </span>
      {% endif %}
      <span class="htmx-indicator text-xs text-muted">updating…</span>
    </div>
  </div>

  <div id="records-container">
    {% include "partials/records_table.html" %}
  </div>
</div>

{# -------------------------------------------------------------------------
   Create new A-record
------------------------------------------------------------------------- #}
<div class="card mb-2">
  <div class="card-header">
    <span class="card-title">Create New A-Record</span>
  </div>
  <div class="card-body">
    <div id="create-record-status"></div>
    <form hx-post="/create-record"
          hx-target="#create-record-status"
          hx-swap="innerHTML"
          hx-on:htmx:after-request="if(event.detail.successful && !this.querySelector('.alert-error')) { this.reset(); location.reload(); }"
          style="display:flex; gap:0.75rem; align-items:flex-end; flex-wrap:wrap;">
      <div class="form-group" style="flex:2; min-width:180px; margin-bottom:0;">
        <label for="create-record-name">Record Name (FQDN)</label>
        <input type="text" id="create-record-name" name="record_name"
               placeholder="home.example.com" required>
      </div>
      <div class="form-group" style="flex:1; min-width:140px; margin-bottom:0;">
        <label for="create-record-ip">IP Address</label>
        <input type="text" id="create-record-ip" name="record_ip"
               placeholder="{{ current_ip }}" value="{{ current_ip }}" required>
      </div>
      <div style="padding-bottom:0;">
        <button type="submit" class="btn btn-primary">Create &amp; Manage</button>
      </div>
    </form>
  </div>
</div>

{# -------------------------------------------------------------------------
   Available Records — compact card grid
------------------------------------------------------------------------- #}
<div class="card mb-2">
  <div class="card-header">
    <span class="card-title">Available Records</span>
    <span style="font-size:0.75rem; color:#64748b;">
      {{ discovery_records | length }} record{{ 's' if discovery_records | length != 1 else '' }}
    </span>
  </div>

  {# Error banners #}
  {% if zone_records_error %}
  <div style="padding:0.5rem 1.25rem; background:#fef3c7; border-bottom:1px solid #fde68a; color:#92400e; font-size:0.8rem;">
    &#9888; Cloudflare: {{ zone_records_error }}
  </div>
  {% endif %}
  {% if k8s_error %}
  <div style="padding:0.5rem 1.25rem; background:#fef3c7; border-bottom:1px solid #fde68a; color:#92400e; font-size:0.8rem;">
    &#9888; Kubernetes: {{ k8s_error }}
  </div>
  {% endif %}

  {% if discovery_records %}
  <div class="discovery-grid">
    {% for r in discovery_records %}
    <div class="discovery-card{% if r.name in managed_names %} discovery-card-managed{% endif %}">
      {# Source badges row #}
      <div class="discovery-card-top">
        {% if r.cf_ip is not none %}
          <span class="badge badge-cf" style="font-size:0.7rem;">CF</span>
        {% endif %}
        {% if r.unifi_ip is not none %}
          <span class="badge badge-unifi" style="font-size:0.7rem;">UniFi</span>
        {% endif %}
        {% if r.k8s_namespace is not none %}
          <span class="badge badge-k8s" style="font-size:0.7rem;">K8s</span>
        {% endif %}
        {% if r.cf_ip is not none %}
          {% if r.cf_proxied %}
            <span class="badge badge-ok" style="font-size:0.7rem;">Proxied</span>
          {% else %}
            <span class="badge badge-neutral" style="font-size:0.7rem;">DNS only</span>
          {% endif %}
        {% endif %}
      </div>
      <div class="discovery-card-name font-mono">{{ r.name }}</div>
      {# Per-source IP / metadata rows #}
      <div class="discovery-card-meta text-muted" style="display:flex; flex-direction:column; gap:0.15rem;">
        {% if r.cf_ip is not none %}
          <span><span class="badge badge-cf" style="font-size:0.65rem; padding:0.1rem 0.35rem; vertical-align:middle;">CF</span>
          <span class="font-mono"> {{ r.cf_ip }}</span></span>
        {% endif %}
        {% if r.unifi_ip is not none %}
          <span><span class="badge badge-unifi" style="font-size:0.65rem; padding:0.1rem 0.35rem; vertical-align:middle;">UniFi</span>
          <span class="font-mono"> {{ r.unifi_ip }}</span></span>
        {% endif %}
        {% if r.k8s_namespace is not none %}
          <span><span class="badge badge-k8s" style="font-size:0.65rem; padding:0.1rem 0.35rem; vertical-align:middle;">K8s</span>
           {{ r.k8s_namespace }}/{{ r.k8s_ingress_name }}</span>
        {% endif %}
      </div>
      <div class="discovery-card-actions">
        {% if r.name not in managed_names %}
          <form hx-post="/add-to-managed"
                hx-target="#records-container"
                hx-swap="innerHTML"
                hx-on:htmx:after-request="if(event.detail.successful) location.reload()"
                style="display:inline">
            <input type="hidden" name="record_name" value="{{ r.name }}">
            <button type="submit" class="btn btn-primary btn-sm">+ Manage</button>
          </form>
          {% if r.cf_record_id %}
          <form hx-post="/delete-record"
                hx-target="#records-container"
                hx-swap="innerHTML"
                hx-confirm="Delete {{ r.name }} from Cloudflare? This cannot be undone."
                hx-on:htmx:after-request="if(event.detail.successful) location.reload()"
                style="display:inline">
            <input type="hidden" name="record_id" value="{{ r.cf_record_id }}">
            <input type="hidden" name="record_name" value="{{ r.name }}">
            <button type="submit" class="btn btn-danger btn-sm">Delete</button>
          </form>
          {% endif %}
        {% else %}
          <span class="badge badge-ok" style="font-size:0.75rem;">&#10003; Managed</span>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="card-body"><span class="text-muted text-sm">No records discovered yet.</span></div>
  {% endif %}
</div>

{% endblock %}

{% block scripts %}
<script>
(function () {
  const el = document.getElementById('next-check-countdown');
  let interval = {{ interval | int }};
  let remaining = interval;
  let timer = null;

  function tick() {
    el.textContent = remaining + 's';
    remaining = remaining > 0 ? remaining - 1 : interval;
  }

  function start(seconds, ivl) {
    interval = ivl;
    remaining = seconds;
    if (timer) clearInterval(timer);
    tick();
    timer = setInterval(tick, 1000);
  }

  // Show placeholder until the fetch resolves so the user never sees a stale full-interval flash.
  el.textContent = '…';
  fetch('/api/next-check-in')
    .then(r => r.json())
    .then(data => start(data.seconds, data.interval))
    .catch(() => start(remaining, interval));
}());
</script>
{% endblock %}
