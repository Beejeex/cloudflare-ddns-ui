{% extends "base.html" %}

{% block title %}DDNS Dashboard{% endblock %}

{% block content %}

{# -------------------------------------------------------------------------
   Stat cards row
------------------------------------------------------------------------- #}
<div class="card-grid mt-2">
  <div class="stat-card">
    <div class="stat-label">Managed Records</div>
    <div class="stat-value">{{ records | length }}</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Total Updates</div>
    <div class="stat-value">{{ records | sum(attribute='updates') }}</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Total Failures</div>
    <div class="stat-value" style="color: {% if records | sum(attribute='failures') > 0 %}#dc2626{% else %}#1e293b{% endif %};">
      {{ records | sum(attribute='failures') }}
    </div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Check Interval</div>
    <div class="stat-value" style="font-size:1.5rem;">{{ interval }}s</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Next Check In</div>
    <div class="stat-value" id="next-check-countdown" style="font-size:1.5rem; color:#0284c7;">&mdash;</div>
  </div>
</div>

{# ---- Cloudflare API error banner ---- #}
{% if api_error %}
<div class="alert" style="background:#fef3c7; color:#92400e; border:1px solid #fde68a; display:flex; align-items:center; gap:0.75rem; margin-bottom:1rem;">
  <span style="font-size:1.125rem;">&#9888;</span>
  <div>
    <strong>Cloudflare API error</strong> &mdash; {{ api_error }}
    <span style="margin-left:0.5rem;">
      <a href="/settings" style="color:#0284c7; font-weight:600;">Go to Settings &rarr;</a>
    </span>
  </div>
</div>
{% endif %}

{# ---- UniFi API error banner ---- #}
{% if unifi_error %}
<div class="alert" style="background:#fef3c7; color:#92400e; border:1px solid #fde68a; display:flex; align-items:center; gap:0.75rem; margin-bottom:1rem;">
  <span style="font-size:1.125rem;">&#9888;</span>
  <div>
    <strong>UniFi API error</strong> &mdash; {{ unifi_error }}
    <span style="margin-left:0.5rem;">
      <a href="/settings" style="color:#0284c7; font-weight:600;">Go to Settings &rarr;</a>
    </span>
  </div>
</div>
{% endif %}

{# -------------------------------------------------------------------------
   Managed records — Cloudflare + UniFi unified table
------------------------------------------------------------------------- #}
<div class="card mb-2">
  <div class="card-header">
    <span class="card-title">Managed DNS Records</span>
    <div style="display:flex; align-items:center; gap:0.75rem;">
      {% if unifi_enabled %}
      <span style="display:inline-flex; align-items:center; gap:0.35rem; font-size:0.75rem; color:#64748b;">
        <span style="width:8px; height:8px; border-radius:50%; background:#0284c7; display:inline-block;"></span>
        UniFi active
      </span>
      {% endif %}
      <span class="htmx-indicator text-xs text-muted">updating…</span>
    </div>
  </div>

  <div id="records-container">
    {% include "partials/records_table.html" %}
  </div>
</div>

{# -------------------------------------------------------------------------
   Create new A-record
------------------------------------------------------------------------- #}
<div class="card mb-2">
  <div class="card-header">
    <span class="card-title">Create New A-Record</span>
  </div>
  <div class="card-body">
    <div id="create-record-status"></div>
    <form hx-post="/create-record"
          hx-target="#create-record-status"
          hx-swap="innerHTML"
          hx-on:htmx:after-request="if(event.detail.successful && !this.querySelector('.alert-error')) { this.reset(); location.reload(); }"
          style="display:flex; gap:0.75rem; align-items:flex-end; flex-wrap:wrap;">
      <div class="form-group" style="flex:2; min-width:180px; margin-bottom:0;">
        <label for="create-record-name">Record Name (FQDN)</label>
        <input type="text" id="create-record-name" name="record_name"
               placeholder="home.example.com" required>
      </div>
      <div class="form-group" style="flex:1; min-width:140px; margin-bottom:0;">
        <label for="create-record-ip">IP Address</label>
        <input type="text" id="create-record-ip" name="record_ip"
               placeholder="{{ current_ip }}" value="{{ current_ip }}" required>
      </div>
      <div style="padding-bottom:0;">
        <button type="submit" class="btn btn-primary">Create &amp; Manage</button>
      </div>
    </form>
  </div>
</div>

{# -------------------------------------------------------------------------
   Kubernetes Ingress Records — auto-discovered hostnames from cluster
------------------------------------------------------------------------- #}
{% if k8s_records is defined %}
<div class="card mb-2">
  <div class="card-header">
    <span class="card-title">Cluster Ingress Records</span>
    <span style="font-size:0.75rem; color:#64748b;">
      {{ k8s_records | length }} hostname{{ 's' if k8s_records | length != 1 else '' }} discovered
    </span>
  </div>
  <div class="card-body">
    {% include "partials/k8s_records_table.html" %}
  </div>
</div>
{% endif %}

{# -------------------------------------------------------------------------
   Cloudflare Zone A-Records — all A records in the zone
------------------------------------------------------------------------- #}
{% if not api_error %}
<div class="card mb-2">
  <div class="card-header">
    <span class="card-title">Cloudflare Zone A-Records</span>
    <span style="font-size:0.75rem; color:#64748b;">
      {{ zone_records | length }} record{{ 's' if zone_records | length != 1 else '' }}
    </span>
  </div>
  {% if zone_records %}
  <table>
    <thead>
      <tr>
        <th>Hostname</th>
        <th>IP</th>
        <th>Proxied</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for r in zone_records %}
      <tr>
        <td class="record-name font-mono">{{ r.name }}</td>
        <td class="font-mono text-sm">{{ r.content }}</td>
        <td>
          {% if r.proxied %}
            <span class="badge badge-ok">Proxied</span>
          {% else %}
            <span class="badge badge-neutral">DNS only</span>
          {% endif %}
        </td>
        <td>
          {% if r.name not in managed_names %}
          <form hx-post="/add-to-managed"
                hx-target="#records-container"
                hx-swap="innerHTML"
                hx-on:htmx:after-request="if(event.detail.successful) location.reload()"
                style="display:inline">
            <input type="hidden" name="record_name" value="{{ r.name }}">
            <button type="submit" class="btn btn-primary btn-sm">+ Manage</button>
          </form>
          {% else %}
          <span class="badge badge-ok">Managed</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% elif zone_records_error %}
  <div class="card-body">
    <span class="text-muted text-sm">{{ zone_records_error }}</span>
  </div>
  {% else %}
  <div class="card-body">
    <span class="text-muted text-sm">No A-records found in zone.</span>
  </div>
  {% endif %}
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
(function () {
  const interval = {{ interval | int }};
  let remaining = interval;
  const el = document.getElementById('next-check-countdown');
  function tick() {
    el.textContent = remaining + 's';
    remaining = remaining > 0 ? remaining - 1 : interval;
  }
  tick();
  setInterval(tick, 1000);
}());
</script>
{% endblock %}
