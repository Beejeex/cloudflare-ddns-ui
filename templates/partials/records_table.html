{# partials/records_table.html - record cards grid #}
{% if records %}
{% for r in records %}
<div class="record-card
  {%- if r.cfg_cf_enabled -%}
    {%- if r.failures > 0 and r.is_up_to_date is not none and not r.is_up_to_date %} accent-error
    {%- elif r.is_up_to_date %} accent-cf-ok
    {%- elif r.is_up_to_date is none %} accent-cf
    {%- else %} accent-cf-warn{%- endif -%}
  {%- elif r.cfg_unifi_enabled -%}
    {%- set unifi_target = r.cfg_unifi_static_ip or unifi_default_ip or '' -%}
    {%- if r.unifi_ip and r.unifi_ip == unifi_target %} accent-unifi-ok{%- else %} accent-unifi{%- endif -%}
  {%- endif %}">
  <div class="record-card-header">
    <div style="display:flex; align-items:center; gap:0.6rem; flex:1; min-width:0; flex-wrap:wrap;">
      <span class="record-name font-mono" style="font-size:0.9375rem;">{{ r.name }}</span>
      {# --- Status badge ---
         CF enabled  → show CF sync state
         CF disabled → show UniFi sync state or Inactive
      #}
      {% if r.cfg_cf_enabled %}
        {% if r.is_up_to_date is none %}
          <span class="badge badge-neutral">Unknown</span>
        {% elif r.is_up_to_date %}
          <span class="badge badge-ok">&#10003; CF up to date</span>
        {% else %}
          <span class="badge badge-warning">&#8593; CF needs update</span>
        {% endif %}
      {% elif r.cfg_unifi_enabled %}
        {% set unifi_target = r.cfg_unifi_static_ip or unifi_default_ip or '' %}
        {% if r.unifi_ip and r.unifi_ip == unifi_target %}
          <span class="badge" style="background:#ede9fe; color:#6d28d9;">&#10003; UniFi synced</span>
        {% elif r.unifi_ip %}
          <span class="badge badge-warning">UniFi out of sync</span>
        {% else %}
          <span class="badge badge-neutral">UniFi pending</span>
        {% endif %}
      {% else %}
        <span class="badge badge-neutral" style="color:#94a3b8;">Inactive</span>
      {% endif %}
    </div>
    <div class="text-sm text-muted" style="white-space:nowrap; flex-shrink:0; font-size:0.78rem;">
      {{ r.updates }} update{{ 's' if r.updates != 1 else '' }} &middot;
      {% if r.failures > 0 %}<span style="color:#dc2626;">{{ r.failures }} failure{{ 's' if r.failures != 1 else '' }}</span>
      {% else %}0 failures{% endif %}
      {% if r.last_checked %}<br><span style="color:#94a3b8;">checked {{ r.last_checked[:16] }}</span>{% endif %}
    </div>
  </div>
  <div class="record-card-ips">
    <div class="record-ip-block">
      <span class="record-ip-label">Cloudflare</span>
      <span class="font-mono" style="font-size:0.875rem;">{{ r.dns_ip }}</span>
    </div>
    {% if unifi_enabled and (r.unifi_ip or r.cfg_unifi_enabled) %}
    <div class="record-ip-block">
      <span class="record-ip-label">UniFi</span>
      {% if r.unifi_ip %}<span class="font-mono" style="font-size:0.875rem;">{{ r.unifi_ip }}</span>
      {% else %}<span class="text-muted" style="font-size:0.8rem;">No policy yet</span>{% endif %}
    </div>
    {% endif %}
  </div>
  {% set slug = r.name | replace('.', '-') | replace('_', '-') %}
  <form id="cfg-form-{{ slug }}"
        hx-post="/update-record-config"
        hx-target="#cfg-status-{{ slug }}"
        hx-swap="innerHTML"
        hx-trigger="change, input delay:1000ms from:[name=static_ip]"
        style="padding:0.875rem 1.1rem; border-top:1px solid #f1f5f9; display:flex; flex-wrap:wrap; gap:1.25rem; align-items:flex-start;">
    <input type="hidden" name="record_name" value="{{ r.name }}">
    <div class="record-cfg-section">
      <label class="record-cfg-toggle">
        <input type="checkbox" name="cf_enabled" value="on" {% if r.cfg_cf_enabled %}checked{% endif %}
               onchange="toggleCfSection('{{ slug }}', this.checked)">
        <span style="font-weight:600; color:#0284c7;">Cloudflare DDNS</span>
      </label>
      <div id="cf-section-{{ slug }}"
           style="padding-left:1.5rem; display:flex; flex-direction:column; gap:0.4rem; margin-top:0.3rem; {% if not r.cfg_cf_enabled %}opacity:0.4; pointer-events:none;{% endif %}">
        <div style="display:flex; gap:1rem;">
          <label class="record-cfg-radio">
            <input type="radio" name="ip_mode" value="dynamic" {% if r.cfg_ip_mode == 'dynamic' %}checked{% endif %}
                   onchange="toggleStaticIp('{{ slug }}', false)">
            <span>Dynamic <span class="text-muted" style="font-size:0.75rem;">(auto-detect)</span></span>
          </label>
          <label class="record-cfg-radio">
            <input type="radio" name="ip_mode" value="static" {% if r.cfg_ip_mode == 'static' %}checked{% endif %}
                   onchange="toggleStaticIp('{{ slug }}', true)">
            <span>Static</span>
          </label>
        </div>
        <div id="static-ip-wrap-{{ slug }}" style="display:{% if r.cfg_ip_mode == 'static' %}flex{% else %}none{% endif %}; align-items:center; gap:0.5rem;">
          <label style="font-size:0.8rem; color:#475569; white-space:nowrap;">External IP</label>
          <input type="text" name="static_ip" value="{{ r.cfg_static_ip }}" placeholder="203.0.113.1"
                 style="width:150px; font-size:0.8125rem; padding:0.3rem 0.6rem; border:1px solid #cbd5e1; border-radius:0.375rem;">
        </div>
      </div>
    </div>
    {% if unifi_enabled %}
    <div class="record-cfg-section">
      <label class="record-cfg-toggle">
        <input type="checkbox" name="unifi_enabled" value="on" {% if r.cfg_unifi_enabled %}checked{% endif %}
               onchange="document.getElementById('unifi-detail-{{ slug }}').style.display=this.checked?'flex':'none'">
        <span style="font-weight:600; color:#6d28d9;">UniFi DNS</span>
      </label>
      <div id="unifi-detail-{{ slug }}"
           style="padding-left:1.5rem; margin-top:0.3rem; display:{% if r.cfg_unifi_enabled %}flex{% else %}none{% endif %}; flex-direction:column; gap:0.35rem;">
        <div style="display:flex; align-items:center; gap:0.5rem;">
          <label style="font-size:0.8rem; color:#475569; white-space:nowrap;">IP Address</label>
          <input type="text" name="unifi_static_ip" value="{{ r.cfg_unifi_static_ip or unifi_default_ip or '' }}"
                 placeholder="e.g. 172.20.0.10"
                 style="width:160px; font-size:0.8125rem; padding:0.3rem 0.6rem; border:1px solid #cbd5e1; border-radius:0.375rem;">
        </div>
        <span class="text-muted" style="font-size:0.75rem;">
          {% if r.unifi_ip %}Synced: <span class="font-mono">{{ r.unifi_ip }}</span>
          {% else %}Will create policy on next check{% endif %}
        </span>
      </div>
    </div>
    {% endif %}
    <div style="margin-left:auto; align-self:center;">
      <span id="cfg-status-{{ slug }}" class="text-sm"></span>
    </div>
  </form>
  <div class="record-card-actions">
    {% if r.cf_record_id %}
    <form hx-post="/delete-record" hx-target="#records-container" hx-swap="innerHTML"
          hx-confirm="Delete {{ r.name }} from Cloudflare AND remove from managed? This cannot be undone."
          hx-on:htmx:after-request="if(event.detail.successful) location.reload()" style="display:inline">
      <input type="hidden" name="record_id" value="{{ r.cf_record_id }}">
      <input type="hidden" name="record_name" value="{{ r.name }}">
      <button type="submit" class="btn btn-danger btn-sm">Delete from CF</button>
    </form>
    {% endif %}
    <form hx-post="/remove-from-managed" hx-target="#records-container" hx-swap="innerHTML"
          hx-confirm="Remove {{ r.name }} from managed? DNS record stays in Cloudflare."
          hx-on:htmx:after-request="if(event.detail.successful) location.reload()" style="display:inline">
      <input type="hidden" name="record_name" value="{{ r.name }}">
      <button type="submit" class="btn btn-ghost btn-sm">Remove</button>
    </form>
  </div>
</div>
{% endfor %}
{% if error_message is defined and error_message %}
<div style="background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; padding:0.75rem 1.25rem; border-radius:0.375rem; grid-column:1/-1; font-size:0.875rem;">{{ error_message }}</div>
{% endif %}
<script>
function toggleCfSection(slug, enabled) {
  var s = document.getElementById('cf-section-' + slug);
  if (s) { s.style.opacity = enabled ? '' : '0.4'; s.style.pointerEvents = enabled ? '' : 'none'; }
}
function toggleStaticIp(slug, show) {
  var w = document.getElementById('static-ip-wrap-' + slug);
  if (w) { w.style.display = show ? 'flex' : 'none'; }
}
</script>
{% else %}
<div style="padding:1.5rem 1.25rem; color:#94a3b8; font-size:0.875rem; grid-column:1/-1;">No records managed yet. Use the form below to create and manage records.</div>
{% endif %}